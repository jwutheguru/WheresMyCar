define(["jquery","geolocation","readout","overlay"],function($,o,t,e){function a(){f=$("#btnSetLocation"),v=$("#btnGetDirection"),m=$("#btnClearSessionData")}function i(){m.on("click",function(o){localStorage[u]="",delete localStorage[u],t.displaySavedLocation(""),t.displayDirection(""),t.displayInformation(""),clearInterval(g),g=null}),f.on("click",function(o){(!p||confirm("You currently have a location saved. Would you like to overwrite it?"))&&(clearInterval(g),g=null,e.showLoading(),navigator.geolocation.getCurrentPosition(n,r))}),v.on("click",function(o){clearInterval(g),e.showLoading(),g=setInterval(function(){navigator.geolocation.getCurrentPosition(c,r)},3e3)})}function n(o,a){e.hideOverlay(),p={coords:{latitude:o.coords.latitude,longitude:o.coords.longitude,altitude:o.coords.altitude,accuracy:o.coords.accuracy,altitudeAccuracy:o.coords.altitudeAccuracy,heading:o.coords.heading,speed:o.coords.speed},timestamp:o.timestamp},localStorage[u]=JSON.stringify(p),t.displaySavedLocation("Saved position"+(a?" (from previous session)":"")+"\n["+new Date(p.timestamp).toString()+"]\n\nDetails:\n\n"+JSON.stringify(p,null,2)),t.displaySavedLocationMap(o),v.prop("disabled",!1)}function c(a){e.hideOverlay(),y={coords:{latitude:a.coords.latitude,longitude:a.coords.longitude,altitude:a.coords.altitude,accuracy:a.coords.accuracy,altitudeAccuracy:a.coords.altitudeAccuracy,heading:a.coords.heading,speed:a.coords.speed},timestamp:a.timestamp},t.displayDirection("Current position\n["+new Date(y.timestamp).toString()+"]\n\nDetails:\n\n"+JSON.stringify(y,null,2));var i=o.calculateDistance(y,p),n=o.calculateBearing(y,p),c=o.getDirectionText(n);t.displayInformation("Your destination is "+i.toFixed(2)+" feet away, bearing "+n.toFixed(2)+" degrees ("+c+")."),t.displayDirectionMap(a)}function r(o){switch(e.hideOverlay(),t.displaySavedLocation(""),t.displayDirection(""),t.displayInformation(""),o.code){case o.PERMISSION_DENIED:t.displayInformation("You have disabled Location Services for this site. This app requires your location to function. Please enable to continue.");break;case o.POSITION_UNAVAILABLE:t.displayInformation("Your location could not be determined.");break;case o.TIMEOUT:t.displayInformation("Attemping to get location timed out and could not be determined.");break;case o.UNKNOWN_ERROR:t.displayInformation("An unknown error has occurred.")}}function d(){var o=localStorage[u];o&&n(JSON.parse(o),!0)}function l(){s||(a(),i(),d(),s=!0)}var s=!1,u="savedLocation",p,y,g,f,v,m;return{start:l,setSavedLocation:function(o){p=o},getSavedLocation:function(){return p}}});