define(["jquery","geolocation","readout","overlay"],function($,o,t,e){function i(){f=$("#btnSetLocation"),v=$("#btnGetDirection"),m=$("#btnClearSessionData")}function a(){m.on("click",function(o){localStorage[u]="",delete localStorage[u],t.displaySavedLocation(""),t.displayDirection(""),t.displayInformation(""),clearInterval(p),p=null}),f.on("click",function(o){(!g||confirm("You currently have a location saved. Would you like to overwrite it?"))&&(clearInterval(p),p=null,e.showLoading(),navigator.geolocation.getCurrentPosition(n,r))}),v.on("click",function(o){clearInterval(p),e.showLoading(),p=setInterval(function(){navigator.geolocation.getCurrentPosition(c,r)},3e3)})}function n(o,i){e.hideOverlay(),g={coords:{latitude:o.coords.latitude,longitude:o.coords.longitude,altitude:o.coords.altitude,accuracy:o.coords.accuracy,altitudeAccuracy:o.coords.altitudeAccuracy,heading:o.coords.heading,speed:o.coords.speed},timestamp:o.timestamp},localStorage[u]=JSON.stringify(g),t.displaySavedLocation("Saved position"+(i?" (from previous session)":"")+"\n["+new Date(g.timestamp).toString()+"]\n\nDetails:\n\n"+JSON.stringify(g,null,2)),v.prop("disabled",!1)}function c(i){e.hideOverlay(),y={coords:{latitude:i.coords.latitude,longitude:i.coords.longitude,altitude:i.coords.altitude,accuracy:i.coords.accuracy,altitudeAccuracy:i.coords.altitudeAccuracy,heading:i.coords.heading,speed:i.coords.speed},timestamp:i.timestamp},t.displayDirection("Current position\n["+new Date(y.timestamp).toString()+"]\n\nDetails:\n\n"+JSON.stringify(y,null,2));var a=o.calculateDistance(y,g),n=o.calculateBearing(y,g),c=o.getDirectionText(n);t.displayInformation("Your destination is "+a.toFixed(2)+" feet away, bearing "+n.toFixed(2)+" degrees ("+c+").")}function r(o){switch(e.hideOverlay(),t.displaySavedLocation(""),t.displayDirection(""),t.displayInformation(""),o.code){case o.PERMISSION_DENIED:t.displayInformation("You have disabled Location Services for this site. This app requires your location to function. Please enable to continue.");break;case o.POSITION_UNAVAILABLE:t.displayInformation("Your location could not be determined.");break;case o.TIMEOUT:t.displayInformation("Attemping to get location timed out and could not be determined.");break;case o.UNKNOWN_ERROR:t.displayInformation("An unknown error has occurred.")}}function d(){var o=localStorage[u];o&&n(JSON.parse(o),!0)}function l(){s||(i(),a(),d(),s=!0)}var s=!1,u="savedLocation",g,y,p,f,v,m;return{start:l,setSavedLocation:function(o){g=o},getSavedLocation:function(){return g}}});